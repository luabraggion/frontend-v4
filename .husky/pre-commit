#!/usr/bin/env sh
# ğŸ¯ Pre-commit hook: Executa lint-staged (fail-fast)
# - Pula execuÃ§Ã£o se nÃ£o houver arquivos staged
# - Usa binÃ¡rio local quando disponÃ­vel, com fallback para npx
# - Permite pular via SKIP_PRECOMMIT=1 ou SKIP_LINT_STAGED=1

# Removi o set -eu que pode causar problemas no Windows

echo "ğŸ” Executando verificaÃ§Ãµes de qualidade (pre-commit)..."

# Permitir pular o hook via variÃ¡vel de ambiente
if [ "${SKIP_PRECOMMIT:-}" = "1" ] || [ "${SKIP_LINT_STAGED:-}" = "1" ]; then
	echo "â­ï¸  SKIP_PRECOMMIT/SKIP_LINT_STAGED ativo â€” pulando lint-staged"
	exit 0
fi

# Garantir que estamos em um repositÃ³rio Git
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
	echo "â„¹ï¸  Fora de um repositÃ³rio Git â€” nada a fazer"
	exit 0
fi

# Executar apenas se houver arquivos staged
if [ -z "$(git diff --name-only --cached)" ]; then
	echo "â„¹ï¸  Nenhum arquivo staged â€” pulando lint-staged"
	exit 0
fi

# Preferir binÃ¡rio local do lint-staged
if [ -x "./node_modules/.bin/lint-staged" ]; then
	./node_modules/.bin/lint-staged
else
	# Tentar npx sem instalar; se falhar, usar npx padrÃ£o
	if command -v npx >/dev/null 2>&1; then
		npx --no-install lint-staged 2>/dev/null || npx lint-staged
	else
		echo "âŒ npx nÃ£o encontrado e lint-staged local ausente."
		exit 1
	fi
fi

echo "âœ… CÃ³digo verificado e corrigido!"
